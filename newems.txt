using System;
using System.Collections.Generic;
using System.Configuration;
using System.Data.SqlClient;
using Microsoft.Data.Sqlite;
using System.IO;

namespace Assembly3DCamera
{
    public static class DatabaseHelper
    {
        public static void ExportTableToSql(SqliteConnection oConn, string vTableName, string dbKey,
                                    string vLogFile, string vCheckpointFile,
                                    Dictionary<string, long> checkpoints)
        {
            string checkpointKey = "SQL|" + dbKey + "|" + vTableName;
            long vLastRowId = checkpoints.ContainsKey(checkpointKey) ? checkpoints[checkpointKey] : 0;

            string vQuery = $"SELECT ROWID, * FROM \"{vTableName}\" WHERE ROWID > {vLastRowId};";

            using (var oCmd = oConn.CreateCommand())
            {
                oCmd.CommandText = vQuery;
                using (var oReader = oCmd.ExecuteReader())
                {
                    if (!oReader.HasRows) return;

                    string sqlTableName = vTableName;
                    string connStr = ConfigurationManager.AppSettings["SqlServerConn"];

                    using (var sqlConn = new SqlConnection(connStr))
                    {
                        sqlConn.Open();
                        CreateSqlTable(sqlConn, oReader, sqlTableName);

                        long vMaxRowId = vLastRowId;
                        int vRowCount = 0;
                        while (oReader.Read())
                        {
                            long vRowId = oReader.GetInt64(0);
                            vMaxRowId = Math.Max(vMaxRowId, vRowId);
                            InsertRow(sqlConn, sqlTableName, oReader);
                            vRowCount++;
                        }

                        checkpoints[checkpointKey] = vMaxRowId;
                        Console.WriteLine($"[{DateTime.Now}] Exported {vRowCount} rows to SQL Server table {sqlTableName}");

                        if (vRowCount > 0)
                        {
                            string logEntry = $"{DateTime.Now}: {vRowCount} new entries came in table {vTableName}\n";
                            File.AppendAllText(vCheckpointFile, logEntry);
                        }
                    }
                }
            }
        }



        private static void CreateSqlTable(SqlConnection sqlConn, SqliteDataReader reader, string sqlTableName)
        {
            using (var cmd = sqlConn.CreateCommand())
            {
                List<string> cols = new List<string>();
                for (int i = 1; i < reader.FieldCount; i++)
                {
                    string colName = reader.GetName(i);
                    cols.Add($"[{colName}] NVARCHAR(MAX)");
                }

                cmd.CommandText = $"IF OBJECT_ID('{sqlTableName}', 'U') IS NULL " +
                                  $"CREATE TABLE [{sqlTableName}] ({string.Join(",", cols)});";
                cmd.ExecuteNonQuery();
            }
        }

        private static void InsertRow(SqlConnection sqlConn, string sqlTableName, SqliteDataReader reader)
        {
            List<string> colNames = new List<string>();
            List<string> colParams = new List<string>();
            var values = new List<SqlParameter>();

            for (int i = 1; i < reader.FieldCount; i++)
            {
                string colName = reader.GetName(i);
                colNames.Add($"[{colName}]");
                colParams.Add($"@p{i}");
                object val = reader.IsDBNull(i) ? DBNull.Value : reader.GetValue(i);
                values.Add(new SqlParameter($"@p{i}", val ?? DBNull.Value));
            }

            string sql = $"INSERT INTO [{sqlTableName}] ({string.Join(",", colNames)}) VALUES ({string.Join(",", colParams)});";
            using (var cmd = new SqlCommand(sql, sqlConn))
            {
                cmd.Parameters.AddRange(values.ToArray());
                cmd.ExecuteNonQuery();
            }
        }
    }
}



using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text;
using Microsoft.Data.Sqlite;

namespace Assembly3DCamera
{
    public static class DataHelper
    {
        // Loads checkpoints from file; format expected: key|value per line.
        public static Dictionary<string, long> LoadCheckpoints(string checkpointFile)
        {
            var dict = new Dictionary<string, long>();
            if (!File.Exists(checkpointFile)) return dict;

            foreach (var rawLine in File.ReadAllLines(checkpointFile))
            {
                var line = rawLine.Trim();
                if (string.IsNullOrEmpty(line)) continue;

                // split by last '|' so keys can themselves contain '|' characters
                int lastPipe = line.LastIndexOf('|');
                if (lastPipe <= 0) continue;

                string key = line.Substring(0, lastPipe);
                string valStr = line.Substring(lastPipe + 1);

                if (long.TryParse(valStr, out long val))
                    dict[key] = val;
            }
            return dict;
        }

        public static void SaveCheckpoints(string checkpointFile, Dictionary<string, long> checkpoints)
        {
            var lines = checkpoints.Select(kv => kv.Key + "|" + kv.Value);
            File.WriteAllLines(checkpointFile, lines);
        }

        public static void ExportTableToCsv(SqliteConnection oConn, string vTableName, string vCsvFolderPath,
                                            string vLogFile, string dbKey, string vCheckpointFile,
                                            Dictionary<string, long> checkpoints)
        {
            string vSafeTable = vTableName.Replace("\"", "\"\"");
            string checkpointKey = dbKey + "|" + vTableName;
            long vLastRowId = checkpoints.ContainsKey(checkpointKey) ? checkpoints[checkpointKey] : 0;

            string vQuery = $"SELECT ROWID, * FROM \"{vSafeTable}\" WHERE ROWID > {vLastRowId};";

            using (var oCmd = oConn.CreateCommand())
            {
                oCmd.CommandText = vQuery;
                using (var oReader = oCmd.ExecuteReader())
                {
                    if (!oReader.HasRows) return;

                    string vCsvFileName = $"{SanitizeFileName(vTableName)}.csv";
                    string vCsvPath = Path.Combine(vCsvFolderPath, vCsvFileName);
                    bool fileExists = File.Exists(vCsvPath);

                    using (var oWriter = new StreamWriter(vCsvPath, true, Encoding.UTF8))
                    {
                        int vCols = oReader.FieldCount;
                        if (!fileExists)
                        {
                            for (int i = 1; i < vCols; i++)
                            {
                                if (i > 1) oWriter.Write(",");
                                oWriter.Write(EscapeCsvField(oReader.GetName(i)));
                            }
                            oWriter.WriteLine();
                        }

                        long vMaxRowId = vLastRowId;
                        int vRowCount = 0;
                        while (oReader.Read())
                        {
                            long vRowId = oReader.GetInt64(0);
                            vMaxRowId = Math.Max(vMaxRowId, vRowId);
                            for (int i = 1; i < vCols; i++)
                            {
                                if (i > 1) oWriter.Write(",");
                                oWriter.Write(oReader.IsDBNull(i) ? "" : EscapeCsvField(oReader.GetValue(i).ToString()));
                            }
                            oWriter.WriteLine();
                            vRowCount++;
                        }

                        checkpoints[checkpointKey] = vMaxRowId;
                        Console.WriteLine($"[{DateTime.Now}] Exported {vRowCount} new rows from '{vTableName}' to {vCsvPath}");

                        if (vRowCount > 0)
                        {
                            string logEntry = $"{DateTime.Now}: {vRowCount} new entries came in table {vTableName}\n";
                            File.AppendAllText(vCheckpointFile, logEntry);
                        }
                    }
                }
            }
        }



        private static string EscapeCsvField(string vValue)
        {
            if (vValue == null) return "";
            bool vMustQuote = vValue.Contains(",") || vValue.Contains("\"") || vValue.Contains("\n") || vValue.Contains("\r");
            if (vValue.Contains("\"")) vValue = vValue.Replace("\"", "\"\"");
            return vMustQuote ? $"\"{vValue}\"" : vValue;
        }

        private static string SanitizeFileName(string vName)
        {
            var vInvalid = Path.GetInvalidFileNameChars();
            var oSb = new StringBuilder();
            foreach (var vChar in vName)
                oSb.Append(vInvalid.Contains(vChar) ? '_' : vChar);
            return oSb.ToString();
        }
    }
}



using System;
using System.Collections.Generic;
using System.Configuration;
using System.IO;
using System.Linq;
using System.Threading;
using Microsoft.Data.Sqlite;

namespace Assembly3DCamera
{
    class Program
    {
        private static Dictionary<string, long> vLastExportedRowId = new Dictionary<string, long>();
        private static Timer oTimer;

        static void Main(string[] args)
        {
            string vDB_CSD = ConfigurationManager.AppSettings["DB_CSD"],
                   vDb_Csv = ConfigurationManager.AppSettings["Db_Csv"],
                   vLogFile = Path.Combine(vDB_CSD, "exceptions.txt"),
                   vCheckpointFile = Path.Combine(vDB_CSD, "data.txt");

            if (string.IsNullOrWhiteSpace(vDB_CSD) || string.IsNullOrWhiteSpace(vDb_Csv))
            {
                Console.WriteLine("Please set DB_CSD and Db_Csv in App.config.");
                return;
            }

            Directory.CreateDirectory(vDb_Csv);
            if (!File.Exists(vLogFile)) File.Create(vLogFile).Dispose();

            vLastExportedRowId = DataHelper.LoadCheckpoints(vCheckpointFile);

            oTimer = new Timer(delegate { ExportDb(vDB_CSD, vDb_Csv, vLogFile, vCheckpointFile); },
                               null, TimeSpan.Zero, TimeSpan.FromMinutes(5));

            Console.WriteLine("Export started.");
            Console.ReadLine();
        }

        static void ExportDb(string vDB_CSD, string vDb_Csv, string vLogFile, string vCheckpointFile)
        {
            try
            {
                string vDbFile = Directory.GetFiles(vDB_CSD, "*.db")
                                          .OrderByDescending(f => new FileInfo(f).LastWriteTime)
                                          .FirstOrDefault();

                if (vDbFile == null)
                {
                    Console.WriteLine($"[{DateTime.Now}] No .db file found in: " + vDB_CSD);
                    return;
                }

                string dbKey = Path.GetFileName(vDbFile);

                // If file replaced (new file), reset checkpoints for this dbKey
                long fileTicks = File.GetLastWriteTimeUtc(vDbFile).Ticks;
                string fileVerKey = "FILEVER|" + dbKey;
                if (!vLastExportedRowId.ContainsKey(fileVerKey) || vLastExportedRowId[fileVerKey] != fileTicks)
                {
                    // remove any entries for this dbKey (CSV and SQL entries)
                    var keysToRemove = vLastExportedRowId.Keys
                        .Where(k => k.StartsWith(dbKey + "|") || k.StartsWith("SQL|" + dbKey + "|"))
                        .ToList();

                    foreach (var k in keysToRemove)
                        vLastExportedRowId.Remove(k);

                    vLastExportedRowId[fileVerKey] = fileTicks;
                    Console.WriteLine($"[{DateTime.Now}] Detected new/changed DB file '{dbKey}'. Resetting checkpoints for this file.");
                }

                using (var oConn = new SqliteConnection("Data Source=" + vDbFile))
                {
                    oConn.Open();
                    using (var oTblCmd = oConn.CreateCommand())
                    {
                        oTblCmd.CommandText = "SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%';";
                        using (var oTblReader = oTblCmd.ExecuteReader())
                        {
                            List<string> vTables = new List<string>();
                            while (oTblReader.Read())
                                vTables.Add(oTblReader.GetString(0));

                            foreach (string vTable in vTables)
                            {
                                try
                                {
                                    DataHelper.ExportTableToCsv(oConn, vTable, vDb_Csv, vLogFile, dbKey, vCheckpointFile, vLastExportedRowId);
                                    DatabaseHelper.ExportTableToSql(oConn, vTable, dbKey, vLogFile, vCheckpointFile, vLastExportedRowId);
                                    // Save checkpoints after each table processed to avoid loss on crash
                                    DataHelper.SaveCheckpoints(vCheckpointFile, vLastExportedRowId);
                                }
                                catch (Exception exTable)
                                {
                                    string vMessage = $"[{DateTime.Now}] Table '{vTable}': {exTable}\n";
                                    File.AppendAllText(vLogFile, vMessage);
                                }
                            }
                        }
                    }
                }

                // Final save after all tables
                DataHelper.SaveCheckpoints(vCheckpointFile, vLastExportedRowId);
                Console.WriteLine($"[{DateTime.Now}] Check complete â€” all tables processed.");
            }
            catch (Exception ex)
            {
                File.AppendAllText(vLogFile, $"[{DateTime.Now}] General DB read error: {ex}\n");
                Console.WriteLine("Error reading DB: " + ex.Message);
            }
        }
    }
}
