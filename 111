// --- Prevent system sleep while logging is active (Win32) ---
[DllImport("kernel32.dll", SetLastError = true)]
private static extern uint SetThreadExecutionState(uint esFlags);

private const uint ES_CONTINUOUS = 0x80000000;
private const uint ES_SYSTEM_REQUIRED = 0x00000001;
private const uint ES_DISPLAY_REQUIRED = 0x00000002;






_____




int vIntervalMinutes = Convert.ToInt32(cmbInterval.SelectedItem.ToString());
timerDownload.Interval = vIntervalMinutes * 60 * 1000; // minutes -> ms
timerDownload.AutoReset = true;
timerDownload.Elapsed -= TimerDownload_Elapsed;
timerDownload.Elapsed += TimerDownload_Elapsed;

// Prevent system from sleeping while logging is active
SetThreadExecutionState(ES_CONTINUOUS | ES_SYSTEM_REQUIRED | ES_DISPLAY_REQUIRED);

// Start background timer
timerDownload.Start();

isCollectingData = true;
lblStatus.Text = $"Data Collection started at {DateTime.Now:HH:mm:ss}";

btnLoginStarted.Enabled = false;
btnLoginStarted.BackColor = Color.Gray;




______




try
{
    if (timerDownload != null)
    {
        timerDownload.Stop();
        timerDownload.Dispose();
        timerDownload = new System.Timers.Timer();
    }
}
catch { /* ignore stop errors */ }

isCollectingData = false;

// Allow system to go to sleep again (clear the previous execution state)
SetThreadExecutionState(ES_CONTINUOUS);

btnLoginStarted.Enabled = true;
btnLoginStarted.BackColor = Color.LightGreen;





___________




private void frmMain_FormClosing(object sender, FormClosingEventArgs e)
{
    try
    {
        // restore normal sleep behavior
        SetThreadExecutionState(ES_CONTINUOUS);

        if (timerDownload != null)
        {
            timerDownload.Stop();
            timerDownload.Dispose();
            timerDownload = null;
        }
    }
    catch { }
}



private void btnDownload_Click(object sender, EventArgs e)
{
    try
    {
        // ✅ Stop timer before export
        if (timerDownload != null)
        {
            try
            {
                timerDownload.Stop();
                timerDownload.Dispose();
                timerDownload = new System.Timers.Timer(); // recreate so you can start again later
            }
            catch (Exception exTimer)
            {
                MessageBox.Show("Error stopping timer: " + exTimer.Message,
                                "Warning", MessageBoxButtons.OK, MessageBoxIcon.Warning);
            }
        }

        isCollectingData = false;

        // ⚙️ Restore system’s normal sleep behavior now that logging stopped
        SetThreadExecutionState(ES_CONTINUOUS);

        // ✅ Check if data available
        if (downloadDataTable == null || downloadDataTable.Rows.Count == 0)
        {
            MessageBox.Show("No data available to download.",
                            "Information", MessageBoxButtons.OK, MessageBoxIcon.Information);
            return;
        }

        // ✅ Choose save location
        SaveFileDialog saveDialog = new SaveFileDialog();
        saveDialog.Filter = "Excel Files (*.xlsx)|*.xlsx";
        saveDialog.FileName = "DataLog_" + DateTime.Now.ToString("yyyyMMdd_HHmmss") + ".xlsx";

        if (saveDialog.ShowDialog() == DialogResult.OK)
        {
            // ✅ Create Excel export object
            ExcelUtlity excelUtil = new ExcelUtlity();

            // ✅ Call with 4 parameters (fixes your earlier error)
            excelUtil.WriteDataTableToExcel(downloadDataTable, "DataLog", saveDialog.FileName, "Modbus Data Log");

            MessageBox.Show("Data successfully downloaded to:\n" + saveDialog.FileName,
                            "Download Complete", MessageBoxButtons.OK, MessageBoxIcon.Information);
        }

        // ✅ Reset UI elements
        downloadDataTable.Rows.Clear();
        btnLoginStarted.Enabled = true;
        btnLoginStarted.BackColor = Color.LightGreen;
        lblStatus.Text = "Data collection stopped and exported successfully.";
    }
    catch (Exception ex)
    {
        MessageBox.Show("Error while downloading data: " + ex.Message,
                        "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
    }
}