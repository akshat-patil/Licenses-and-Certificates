using System;
using System.Configuration;
using System.Data;
using Microsoft.Data.Sqlite;
using Microsoft.Data.SqlClient;
using System.IO;
using System.Text;

namespace AssemblyDataTransfer
{
    class Program
    {
        static void Main(string[] args)
        {
            string folderPath = ConfigurationManager.AppSettings["DbFolderPath"];
            string sqlConnectionString = ConfigurationManager.AppSettings["SqlConnectionString"];

            Console.WriteLine("Monitoring folder: " + folderPath);

            while (true)
            {
                try
                {
                    // Find latest .db file
                    string dbFile = GetLatestDbFile(folderPath);
                    if (dbFile == null)
                    {
                        Console.WriteLine("No .db file found yet. Retrying in 30s...");
                        System.Threading.Thread.Sleep(30000);
                        continue;
                    }

                    Console.WriteLine("Processing file: " + dbFile);

                    using (var sqliteConn = new SqliteConnection($"Data Source={dbFile}"))
                    {
                        sqliteConn.Open();

                        // Get all table names
                        var getTablesCmd = sqliteConn.CreateCommand();
                        getTablesCmd.CommandText = "SELECT name FROM sqlite_master WHERE type='table'";
                        using (var reader = getTablesCmd.ExecuteReader())
                        {
                            while (reader.Read())
                            {
                                string tableName = reader.GetString(0);
                                Console.WriteLine($"Processing table: {tableName}");

                                // Load table schema
                                DataTable schemaTable = sqliteConn.GetSchema("Columns", new string[] { null, null, tableName, null });

                                // Create table in SQL Server if not exists
                                CreateSqlServerTable(sqlConnectionString, tableName, schemaTable);

                                // Copy data
                                CopyData(sqliteConn, sqlConnectionString, tableName, schemaTable);
                            }
                        }
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine("Error: " + ex.Message);
                }

                Console.WriteLine("Sleeping 5 minutes before checking again...");
                System.Threading.Thread.Sleep(TimeSpan.FromMinutes(5));
            }
        }

        static string GetLatestDbFile(string folderPath)
        {
            if (!Directory.Exists(folderPath))
                return null;

            var files = Directory.GetFiles(folderPath, "*.db");
            if (files.Length == 0) return null;

            return files[0]; // If multiple, you can pick latest: OrderByDescending(f => File.GetLastWriteTime(f)).First()
        }

        static void CreateSqlServerTable(string sqlConnStr, string tableName, DataTable schemaTable)
        {
            using (SqlConnection sqlConn = new SqlConnection(sqlConnStr))
            {
                sqlConn.Open();

                // Check if table exists
                string checkTableQuery = $"IF NOT EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = '{tableName}') BEGIN ";
                StringBuilder createTableQuery = new StringBuilder();
                createTableQuery.Append($"CREATE TABLE [{tableName}] (");

                foreach (DataRow col in schemaTable.Rows)
                {
                    string colName = col["COLUMN_NAME"].ToString();
                    string colType = col["DATA_TYPE"].ToString().ToLower();

                    string sqlType = MapSqlType(colType);
                    createTableQuery.Append($"[{colName}] {sqlType},");
                }
                createTableQuery.Length--; // remove last comma
                createTableQuery.Append(") END");

                using (SqlCommand cmd = new SqlCommand(checkTableQuery + createTableQuery.ToString(), sqlConn))
                {
                    cmd.ExecuteNonQuery();
                }
            }
        }

        static string MapSqlType(string sqliteType)
        {
            return sqliteType switch
            {
                "integer" => "INT",
                "real" => "FLOAT",
                "text" => "NVARCHAR(MAX)",
                "blob" => "VARBINARY(MAX)",
                _ => "NVARCHAR(MAX)"
            };
        }

        static void CopyData(SqliteConnection sqliteConn, string sqlConnStr, string tableName, DataTable schemaTable)
        {
            using (SqliteCommand cmd = sqliteConn.CreateCommand())
            {
                cmd.CommandText = $"SELECT * FROM [{tableName}]";
                using (var reader = cmd.ExecuteReader())
                {
                    using (SqlConnection sqlConn = new SqlConnection(sqlConnStr))
                    {
                        sqlConn.Open();

                        while (reader.Read())
                        {
                            StringBuilder cols = new StringBuilder();
                            StringBuilder vals = new StringBuilder();

                            for (int i = 0; i < reader.FieldCount; i++)
                            {
                                string colName = reader.GetName(i);
                                object val = reader.GetValue(i);

                                cols.Append($"[{colName}],");
                                vals.Append(val == DBNull.Value ? "NULL," : $"'{val.ToString().Replace("'", "''")}',");
                            }

                            if (cols.Length > 0)
                            {
                                cols.Length--;
                                vals.Length--;
                            }

                            string insertQuery = $"IF NOT EXISTS (SELECT 1 FROM [{tableName}] WHERE {BuildWhereClause(reader)}) " +
                                                 $"INSERT INTO [{tableName}] ({cols}) VALUES ({vals})";

                            using (SqlCommand insertCmd = new SqlCommand(insertQuery, sqlConn))
                            {
                                insertCmd.ExecuteNonQuery();
                            }
                        }
                    }
                }
            }
        }

        static string BuildWhereClause(SqliteDataReader reader)
        {
            StringBuilder where = new StringBuilder("1=1");
            for (int i = 0; i < reader.FieldCount; i++)
            {
                object val = reader.GetValue(i);
                string colName = reader.GetName(i);

                if (val == DBNull.Value) continue;

                where.Append($" AND [{colName}] = '{val.ToString().Replace("'", "''")}'");
            }
            return where.ToString();
        }
    }
}






using System;
using System.Configuration;
using System.Data;
using System.IO;
using System.Security.Cryptography;
using System.Text;
using Microsoft.Data.Sqlite;
using Microsoft.Data.SqlClient;

namespace AssemblyDataTransfer
{
    class Program
    {
        static void Main(string[] args)
        {
            try
            {
                string folderPath = ConfigurationManager.AppSettings["DbFolderPath"];
                string sqlConnectionString = ConfigurationManager.AppSettings["SqlConnectionString"];

                Console.WriteLine("Checking folder: " + folderPath);

                string dbFile = GetLatestDbFile(folderPath);
                if (dbFile == null)
                {
                    Console.WriteLine("No .db file found. Exiting.");
                    return;
                }

                Console.WriteLine("Processing file: " + dbFile);

                using (var sqliteConn = new SqliteConnection($"Data Source={dbFile}"))
                using (var sqlConn = new SqlConnection(sqlConnectionString))
                {
                    sqliteConn.Open();
                    sqlConn.Open();

                    // get all tables from .db
                    var getTablesCmd = sqliteConn.CreateCommand();
                    getTablesCmd.CommandText = "SELECT name FROM sqlite_master WHERE type='table';";

                    using (var reader = getTablesCmd.ExecuteReader())
                    {
                        while (reader.Read())
                        {
                            string tableName = reader.GetString(0);
                            Console.WriteLine("Syncing table: " + tableName);
                            SyncTable(sqliteConn, sqlConn, tableName);
                        }
                    }
                }

                Console.WriteLine("✅ Sync complete.");
            }
            catch (Exception ex)
            {
                Console.WriteLine("❌ ERROR: " + ex.Message);
            }
        }

        static string GetLatestDbFile(string folderPath)
        {
            if (!Directory.Exists(folderPath))
                return null;

            string[] files = Directory.GetFiles(folderPath, "*.db");
            if (files.Length == 0)
                return null;

            Array.Sort(files, (a, b) => File.GetLastWriteTime(b).CompareTo(File.GetLastWriteTime(a)));
            return files[0]; // newest file
        }

        static void SyncTable(SqliteConnection sqliteConn, SqlConnection sqlConn, string tableName)
        {
            // get table schema
            var schemaCmd = sqliteConn.CreateCommand();
            schemaCmd.CommandText = $"PRAGMA table_info([{tableName}]);";

            DataTable schemaTable = new DataTable();
            using (var reader = schemaCmd.ExecuteReader())
            {
                schemaTable.Load(reader);
            }

            // build CREATE TABLE query for SQL Server
            StringBuilder createSql = new StringBuilder();
            createSql.Append($"IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='{tableName}' AND xtype='U') ");
            createSql.Append("CREATE TABLE [" + tableName + "] (");

            foreach (DataRow row in schemaTable.Rows)
            {
                string colName = row["name"].ToString();
                string colType = row["type"].ToString();
                createSql.Append("[" + colName + "] " + MapSqlType(colType) + ",");
            }

            createSql.Append("[_hash] NVARCHAR(64));"); // hash column for uniqueness

            using (var cmd = new SqlCommand(createSql.ToString(), sqlConn))
            {
                cmd.ExecuteNonQuery();
            }

            // read all rows from sqlite
            var selectCmd = sqliteConn.CreateCommand();
            selectCmd.CommandText = $"SELECT * FROM [{tableName}]";

            using (var reader = selectCmd.ExecuteReader())
            {
                DataTable data = new DataTable();
                data.Load(reader);

                foreach (DataRow row in data.Rows)
                {
                    string hash = GetRowHash(row);

                    // check if row exists
                    string existsSql = $"SELECT COUNT(*) FROM [{tableName}] WHERE [_hash] = @hash";
                    using (var checkCmd = new SqlCommand(existsSql, sqlConn))
                    {
                        checkCmd.Parameters.AddWithValue("@hash", hash);
                        int count = (int)checkCmd.ExecuteScalar();
                        if (count > 0)
                            continue; // skip duplicate
                    }

                    // build insert query
                    StringBuilder cols = new StringBuilder();
                    StringBuilder vals = new StringBuilder();

                    foreach (DataColumn col in data.Columns)
                    {
                        cols.Append("[" + col.ColumnName + "],");
                        vals.Append("@" + col.ColumnName + ",");
                    }
                    cols.Append("[_hash]");
                    vals.Append("@hash");

                    string insertSql = $"INSERT INTO [{tableName}] ({cols}) VALUES ({vals})";

                    using (var insertCmd = new SqlCommand(insertSql, sqlConn))
                    {
                        foreach (DataColumn col in data.Columns)
                        {
                            insertCmd.Parameters.AddWithValue("@" + col.ColumnName, row[col] ?? DBNull.Value);
                        }
                        insertCmd.Parameters.AddWithValue("@hash", hash);
                        insertCmd.ExecuteNonQuery();
                    }
                }
            }
        }

        static string MapSqlType(string sqliteType)
        {
            sqliteType = sqliteType.ToLower();
            if (sqliteType.Contains("int"))
                return "BIGINT";
            else if (sqliteType.Contains("real") || sqliteType.Contains("floa") || sqliteType.Contains("doub"))
                return "FLOAT";
            else if (sqliteType.Contains("text") || sqliteType.Contains("char") || sqliteType.Contains("clob"))
                return "NVARCHAR(MAX)";
            else if (sqliteType.Contains("blob"))
                return "VARBINARY(MAX)";
            else
                return "NVARCHAR(MAX)";
        }

        static string GetRowHash(DataRow row)
        {
            StringBuilder sb = new StringBuilder();
            foreach (var item in row.ItemArray)
            {
                sb.Append(item == null ? "NULL" : item.ToString());
                sb.Append("|");
            }

            using (SHA256 sha = SHA256.Create())
            {
                byte[] hashBytes = sha.ComputeHash(Encoding.UTF8.GetBytes(sb.ToString()));
                return BitConverter.ToString(hashBytes).Replace("-", "");
            }
        }
    }
}