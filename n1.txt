<?xml version="1.0" encoding="utf-8" ?>
<configuration>
  <connectionStrings>
    <add name="EmsDb"
         connectionString="Server=.\SQLEXPRESS;Database=ems;User Id=sa;Password=YourPassword;"
         providerName="System.Data.SqlClient"/>
  </connectionStrings>

  <appSettings>
    <add key="vEmsCsvInputFolder" value="C:\EMS\InputCSVs"/>
    <add key="vEmsCsvArchiveRoot" value="C:\EMS\Archive"/>
    <add key="vEmsErrorLogFile" value="C:\EMS\Logs\error_log.txt"/>
  </appSettings>
</configuration>




using System;
using System.Configuration;
using System.IO;

namespace EmsConsole
{
    class Program
    {
        static void Main(string[] args)
        {
            string vCsvInputFolder = ConfigurationManager.AppSettings["vEmsCsvInputFolder"];
            string vArchiveRootFolder = ConfigurationManager.AppSettings["vEmsCsvArchiveRoot"];
            string vLogFile = ConfigurationManager.AppSettings["vEmsErrorLogFile"];

            try
            {
                DateTime vToday = DateTime.Now;

                // Create Year folder
                string vYearFolder = Path.Combine(vArchiveRootFolder, vToday.Year.ToString());
                if (!Directory.Exists(vYearFolder)) Directory.CreateDirectory(vYearFolder);

                // Create Month folder
                string vMonthFolder = Path.Combine(vYearFolder, vToday.ToString("MM"));
                if (!Directory.Exists(vMonthFolder)) Directory.CreateDirectory(vMonthFolder);

                // Create Date folder
                string vDateFolder = Path.Combine(vMonthFolder, vToday.ToString("ddMMyyyy"));
                if (!Directory.Exists(vDateFolder)) Directory.CreateDirectory(vDateFolder);

                // Copy CSVs and process
                foreach (string vCsvFile in Directory.GetFiles(vCsvInputFolder, "*.csv"))
                {
                    string vDestFile = Path.Combine(vDateFolder, Path.GetFileName(vCsvFile));
                    File.Copy(vCsvFile, vDestFile, true);

                    Console.WriteLine($"Processing {vCsvFile}...");
                    CsvParser.ParseAndInsert(vDestFile, vLogFile);
                }
            }
            catch (Exception oEx)
            {
                File.AppendAllText(vLogFile, $"{DateTime.Now}: {oEx.Message}{Environment.NewLine}");
            }
        }
    }
}



using System;
using System.Configuration;
using System.Data.SqlClient;
using System.Globalization;
using System.IO;
using System.Linq;

namespace EmsConsole
{
    public static class CsvParser
    {
        public static void ParseAndInsert(string vCsvFilePath, string vLogFile)
        {
            try
            {
                string vConnectionString = ConfigurationManager.ConnectionStrings["EmsDb"].ConnectionString;

                using (SqlConnection oSqlConn = new SqlConnection(vConnectionString))
                {
                    oSqlConn.Open();
                    string[] vAllLines = File.ReadAllLines(vCsvFilePath);

                    if (vAllLines.Length < 2) return;

                    // Read header to find column indexes
                    string[] vHeader = vAllLines[0].Split(',');

                    int vGatewayCol = Array.FindIndex(vHeader, h => h.Equals("Gateway Name", StringComparison.OrdinalIgnoreCase));
                    int vDeviceCol = Array.FindIndex(vHeader, h => h.Equals("Device Name", StringComparison.OrdinalIgnoreCase));
                    int vTimestampCol = Array.FindIndex(vHeader, h => h.Equals("Local TimeStamp", StringComparison.OrdinalIgnoreCase));
                    int vEnergyCol = Array.FindIndex(vHeader, h =>
                        h.Equals("TotalDeliveredActiveEnergy (Wh)", StringComparison.OrdinalIgnoreCase) ||
                        h.Equals("Active energy (Wh)", StringComparison.OrdinalIgnoreCase) ||
                        h.Equals("Active energy delivered (Wh)", StringComparison.OrdinalIgnoreCase));

                    for (int i = 1; i < vAllLines.Length; i++)
                    {
                        try
                        {
                            string[] vParts = vAllLines[i].Split(',');

                            string vGatewayName = vGatewayCol >= 0 && vParts.Length > vGatewayCol ? vParts[vGatewayCol] : null;
                            string vDeviceName = vDeviceCol >= 0 && vParts.Length > vDeviceCol ? vParts[vDeviceCol] : null;

                            DateTime? vTimestamp = null;
                            if (vTimestampCol >= 0 && vParts.Length > vTimestampCol && DateTime.TryParse(vParts[vTimestampCol], out DateTime vTs))
                                vTimestamp = vTs;

                            decimal? vEnergy = null;
                            if (vEnergyCol >= 0 && vParts.Length > vEnergyCol && decimal.TryParse(vParts[vEnergyCol], NumberStyles.Any, CultureInfo.InvariantCulture, out decimal vVal))
                                vEnergy = vVal;

                            int vDeviceId = InsertOrGetDevice(oSqlConn, vGatewayName, vDeviceName);

                            using (SqlCommand oCmd = new SqlCommand(
                                "INSERT INTO ems.EnergyReadings (DeviceId, LocalTimestamp, ActiveDeliveredEnergy) VALUES (@DeviceId, @LocalTimestamp, @Energy)", oSqlConn))
                            {
                                oCmd.Parameters.AddWithValue("@DeviceId", (object)vDeviceId ?? DBNull.Value);
                                oCmd.Parameters.AddWithValue("@LocalTimestamp", (object)vTimestamp ?? DBNull.Value);
                                oCmd.Parameters.AddWithValue("@Energy", (object)vEnergy ?? DBNull.Value);
                                oCmd.ExecuteNonQuery();
                            }
                        }
                        catch (Exception oInnerEx)
                        {
                            File.AppendAllText(vLogFile, $"{DateTime.Now}: Error in line {i + 1}: {oInnerEx.Message}{Environment.NewLine}");
                        }
                    }
                }
            }
            catch (Exception oEx)
            {
                File.AppendAllText(vLogFile, $"{DateTime.Now}: {oEx.Message}{Environment.NewLine}");
            }
        }

        private static int InsertOrGetDevice(SqlConnection oSqlConn, string vGatewayName, string vDeviceName)
        {
            using (SqlCommand oCheckCmd = new SqlCommand(
                "SELECT DeviceId FROM ems.Device WHERE GatewayName = @GatewayName AND DeviceName = @DeviceName", oSqlConn))
            {
                oCheckCmd.Parameters.AddWithValue("@GatewayName", (object)vGatewayName ?? DBNull.Value);
                oCheckCmd.Parameters.AddWithValue("@DeviceName", (object)vDeviceName ?? DBNull.Value);

                object oResult = oCheckCmd.ExecuteScalar();
                if (oResult != null) return (int)oResult;
            }

            using (SqlCommand oInsertCmd = new SqlCommand(
                "INSERT INTO ems.Device (GatewayName, DeviceName) OUTPUT INSERTED.DeviceId VALUES (@GatewayName, @DeviceName)", oSqlConn))
            {
                oInsertCmd.Parameters.AddWithValue("@GatewayName", (object)vGatewayName ?? DBNull.Value);
                oInsertCmd.Parameters.AddWithValue("@DeviceName", (object)vDeviceName ?? DBNull.Value);
                return (int)oInsertCmd.ExecuteScalar();
            }
        }
    }
}




using System;
using System.Configuration;
using System.Data.SqlClient;
using System.Globalization;
using System.IO;
using System.Linq;

namespace EmsConsole
{
    public static class CsvParser
    {
        public static void ParseAndInsert(string vCsvFilePath, string vLogFile)
        {
            try
            {
                string vConnectionString = ConfigurationManager.ConnectionStrings["EmsDb"].ConnectionString;

                string[] vAllLines = File.ReadAllLines(vCsvFilePath);
                if (vAllLines.Length < 2)
                {
                    File.AppendAllText(vLogFile, $"{DateTime.Now}: File too short: {vCsvFilePath}{Environment.NewLine}");
                    return;
                }

                // Helper to clean headers
                string Clean(string s) => s.Trim().Trim('"');

                // ======= Step 1: Detect Gateway & Device =======
                string[] vHeaderRow = vAllLines[0].Split(',');
                string[] vValueRow = vAllLines[1].Split(',');

                int vGatewayCol = Array.FindIndex(vHeaderRow, h => Clean(h).Equals("Gateway Name", StringComparison.OrdinalIgnoreCase));
                int vDeviceCol = Array.FindIndex(vHeaderRow, h => Clean(h).Equals("Device Name", StringComparison.OrdinalIgnoreCase));

                string vGatewayName = vGatewayCol >= 0 && vValueRow.Length > vGatewayCol ? vValueRow[vGatewayCol] : null;
                string vDeviceName = vDeviceCol >= 0 && vValueRow.Length > vDeviceCol ? vValueRow[vDeviceCol] : null;

                if (vGatewayName == null || vDeviceName == null)
                {
                    File.AppendAllText(vLogFile, $"{DateTime.Now}: Could not detect Gateway or Device in {vCsvFilePath}{Environment.NewLine}");
                    return;
                }

                // ======= Step 2: Detect Data Header =======
                // Find the row where timestamp and energy columns exist
                int vDataHeaderRowIndex = Array.FindIndex(vAllLines, line =>
                {
                    string[] parts = line.Split(',');
                    return parts.Any(p => Clean(p).Equals("Local TimeStamp", StringComparison.OrdinalIgnoreCase));
                });

                if (vDataHeaderRowIndex < 0)
                {
                    File.AppendAllText(vLogFile, $"{DateTime.Now}: Could not find data header in {vCsvFilePath}{Environment.NewLine}");
                    return;
                }

                string[] vDataHeader = vAllLines[vDataHeaderRowIndex].Split(',');

                int vTimestampCol = Array.FindIndex(vDataHeader, h => Clean(h).Equals("Local TimeStamp", StringComparison.OrdinalIgnoreCase));
                int vEnergyCol = Array.FindIndex(vDataHeader, h =>
                    Clean(h).Equals("TotalDeliveredActiveEnergy (Wh)", StringComparison.OrdinalIgnoreCase) ||
                    Clean(h).Equals("Active energy (Wh)", StringComparison.OrdinalIgnoreCase) ||
                    Clean(h).Equals("Active energy delivered (Wh)", StringComparison.OrdinalIgnoreCase));

                if (vTimestampCol < 0 || vEnergyCol < 0)
                {
                    File.AppendAllText(vLogFile, $"{DateTime.Now}: Could not detect Timestamp or Energy column in {vCsvFilePath}{Environment.NewLine}");
                    return;
                }

                // ======= Step 3: Insert into SQL =======
                using (SqlConnection oSqlConn = new SqlConnection(vConnectionString))
                {
                    oSqlConn.Open();

                    int vDeviceId = InsertOrGetDevice(oSqlConn, vGatewayName, vDeviceName);

                    for (int i = vDataHeaderRowIndex + 1; i < vAllLines.Length; i++)
                    {
                        try
                        {
                            string[] vParts = vAllLines[i].Split(',');

                            DateTime? vTimestamp = null;
                            decimal? vEnergy = null;

                            if (vParts.Length > vTimestampCol && DateTime.TryParse(vParts[vTimestampCol], out DateTime ts))
                                vTimestamp = ts;

                            if (vParts.Length > vEnergyCol && decimal.TryParse(vParts[vEnergyCol], NumberStyles.Any, CultureInfo.InvariantCulture, out decimal en))
                                vEnergy = en;

                            // Skip if both timestamp and energy are null
                            if (vTimestamp == null && vEnergy == null) continue;

                            using (SqlCommand oCmd = new SqlCommand(
                                "INSERT INTO ems.EnergyReadings (DeviceId, LocalTimestamp, ActiveDeliveredEnergy) VALUES (@DeviceId, @LocalTimestamp, @Energy)", oSqlConn))
                            {
                                oCmd.Parameters.AddWithValue("@DeviceId", vDeviceId);
                                oCmd.Parameters.AddWithValue("@LocalTimestamp", (object)vTimestamp ?? DBNull.Value);
                                oCmd.Parameters.AddWithValue("@Energy", (object)vEnergy ?? DBNull.Value);
                                oCmd.ExecuteNonQuery();
                            }
                        }
                        catch (Exception oInnerEx)
                        {
                            File.AppendAllText(vLogFile, $"{DateTime.Now}: Row {i + 1} error: {oInnerEx.Message}{Environment.NewLine}");
                        }
                    }
                }

                File.AppendAllText(vLogFile, $"{DateTime.Now}: Successfully processed {vCsvFilePath}{Environment.NewLine}");
            }
            catch (Exception oEx)
            {
                File.AppendAllText(vLogFile, $"{DateTime.Now}: General error in file {vCsvFilePath}: {oEx.Message}{Environment.NewLine}");
            }
        }

        private static int InsertOrGetDevice(SqlConnection oSqlConn, string vGatewayName, string vDeviceName)
        {
            using (SqlCommand oCheckCmd = new SqlCommand(
                "SELECT DeviceId FROM ems.Device WHERE GatewayName=@GatewayName AND DeviceName=@DeviceName", oSqlConn))
            {
                oCheckCmd.Parameters.AddWithValue("@GatewayName", (object)vGatewayName ?? DBNull.Value);
                oCheckCmd.Parameters.AddWithValue("@DeviceName", (object)vDeviceName ?? DBNull.Value);

                object oResult = oCheckCmd.ExecuteScalar();
                if (oResult != null) return (int)oResult;
            }

            using (SqlCommand oInsertCmd = new SqlCommand(
                "INSERT INTO ems.Device (GatewayName, DeviceName) OUTPUT INSERTED.DeviceId VALUES (@GatewayName, @DeviceName)", oSqlConn))
            {
                oInsertCmd.Parameters.AddWithValue("@GatewayName", (object)vGatewayName ?? DBNull.Value);
                oInsertCmd.Parameters.AddWithValue("@DeviceName", (object)vDeviceName ?? DBNull.Value);
                return (int)oInsertCmd.ExecuteScalar();
            }
        }
    }
}












using System;
using System.Collections.Generic;
using System.Configuration;
using System.Data.SqlClient;
using System.Globalization;
using System.IO;
using System.Linq;

namespace EmsConsole
{
    class CsvParser
    {
        public static void ParseAndInsert(string csvFile, string logFile)
        {
            try
            {
                var allLines = File.ReadAllLines(csvFile);
                if (allLines.Length == 0) return;

                // find header row
                int headerRowIndex = -1;
                string[] headers = null;

                for (int i = 0; i < allLines.Length; i++)
                {
                    var cols = allLines[i].Split(',').Select(x => x.Trim()).ToArray();
                    if (cols.Any(c => c.Equals("Gateway Name", StringComparison.OrdinalIgnoreCase)))
                    {
                        headers = cols;
                        headerRowIndex = i;
                        break;
                    }
                }

                if (headers == null) throw new Exception("Header row not found in CSV file: " + csvFile);

                // column indexes
                int gatewayIndex = Array.FindIndex(headers, h => h.Equals("Gateway Name", StringComparison.OrdinalIgnoreCase));
                int deviceIndex = Array.FindIndex(headers, h => h.Equals("Device Name", StringComparison.OrdinalIgnoreCase));
                int timeIndex = Array.FindIndex(headers, h => h.Equals("Local Time Stamp", StringComparison.OrdinalIgnoreCase));
                int energyIndex = Array.FindIndex(headers, h =>
                    h.Equals("TotalDeliveredActiveEnergy (Wh)", StringComparison.OrdinalIgnoreCase) ||
                    h.Equals("Active energy (Wh)", StringComparison.OrdinalIgnoreCase) ||
                    h.Equals("Active energy delivered (Wh)", StringComparison.OrdinalIgnoreCase));

                if (gatewayIndex == -1 || deviceIndex == -1 || timeIndex == -1 || energyIndex == -1)
                    throw new Exception("Required columns not found in " + csvFile);

                // Gateway and Device (from first data row after header)
                string gatewayName = allLines[headerRowIndex + 1].Split(',')[gatewayIndex].Trim();
                string deviceName = allLines[headerRowIndex + 1].Split(',')[deviceIndex].Trim();

                // Parse multiple records
                List<(DateTime LocalTime, double Energy)> records = new List<(DateTime, double)>();

                for (int i = headerRowIndex + 1; i < allLines.Length; i++)
                {
                    var cols = allLines[i].Split(',').Select(x => x.Trim()).ToArray();
                    if (cols.Length <= Math.Max(timeIndex, energyIndex)) continue;

                    if (DateTime.TryParse(cols[timeIndex], out DateTime localTime) &&
                        double.TryParse(cols[energyIndex], NumberStyles.Any, CultureInfo.InvariantCulture, out double energyValue))
                    {
                        records.Add((localTime, energyValue));
                    }
                }

                // Save to DB
                InsertIntoDatabase(gatewayName, deviceName, records);
            }
            catch (Exception ex)
            {
                File.AppendAllText(logFile, $"{DateTime.Now}: {ex.Message}{Environment.NewLine}");
            }
        }

        private static void InsertIntoDatabase(string gateway, string device, List<(DateTime LocalTime, double Energy)> records)
        {
            string connectionString = ConfigurationManager.ConnectionStrings["EmsDb"].ConnectionString;

            using (SqlConnection conn = new SqlConnection(connectionString))
            {
                conn.Open();

                // Check if Device already exists
                int deviceId;
                string checkDeviceSql = "SELECT DeviceId FROM ems.Device WHERE GatewayName = @GatewayName AND DeviceName = @DeviceName";

                using (SqlCommand cmd = new SqlCommand(checkDeviceSql, conn))
                {
                    cmd.Parameters.AddWithValue("@GatewayName", gateway);
                    cmd.Parameters.AddWithValue("@DeviceName", device);

                    var result = cmd.ExecuteScalar();
                    if (result != null)
                    {
                        deviceId = Convert.ToInt32(result);
                    }
                    else
                    {
                        // Insert new device
                        string insertDeviceSql = "INSERT INTO ems.Device (GatewayName, DeviceName) OUTPUT INSERTED.DeviceId VALUES (@GatewayName, @DeviceName)";
                        using (SqlCommand insertCmd = new SqlCommand(insertDeviceSql, conn))
                        {
                            insertCmd.Parameters.AddWithValue("@GatewayName", gateway);
                            insertCmd.Parameters.AddWithValue("@DeviceName", device);
                            deviceId = (int)insertCmd.ExecuteScalar();
                        }
                    }
                }

                // Insert Energy Readings
                string insertReadingSql = @"
                    INSERT INTO ems.EnergyReadings (DeviceId, LocalTimestamp, ActiveEnergyDeliveted)
                    VALUES (@DeviceId, @LocalTimestamp, @ActiveEnergyDeliveted)";

                foreach (var record in records)
                {
                    using (SqlCommand cmd = new SqlCommand(insertReadingSql, conn))
                    {
                        cmd.Parameters.AddWithValue("@DeviceId", deviceId);
                        cmd.Parameters.AddWithValue("@LocalTimestamp", record.LocalTime);
                        cmd.Parameters.AddWithValue("@ActiveEnergyDeliveted", record.Energy);
                        cmd.ExecuteNonQuery();
                    }
                }
            }
        }
    }
}