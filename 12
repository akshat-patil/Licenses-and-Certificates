protected void btnSubmit_Click(object sender, EventArgs e)
{
    SqlTransaction tran = null;
    try
    {
        int sid = Convert.ToInt32(hdnsid.Value);
        string userId = Session["uid"].ToString();
        string commentText = txtCtrlRemark.Text.Trim(); // change control name if different
        string commentColumn = "controllingComment";
        int currentStatus = 1; // Controlling

        using (SqlConnection con = new SqlConnection(ConfigurationManager.ConnectionStrings["SiteSqlServer"].ToString()))
        {
            con.Open();
            tran = con.BeginTransaction();

            // find current fid
            int currentFid = 0;
            using (SqlCommand cmdF = new SqlCommand("SELECT MIN([fid]) FROM [tblFlow] WHERE [sid]=@sid AND [status]=@status", con, tran))
            {
                cmdF.Parameters.AddWithValue("@sid", sid);
                cmdF.Parameters.AddWithValue("@status", currentStatus);
                object of = cmdF.ExecuteScalar();
                if (of != null && of != DBNull.Value) currentFid = Convert.ToInt32(of);
            }

            // get next step
            int nextStatus = 0; string nextText = "";
            using (SqlCommand cmdN = new SqlCommand("SELECT TOP 1 [fid],[status],[statusText] FROM [tblFlow] WHERE [sid]=@sid AND [fid] > @fid ORDER BY [fid] ASC", con, tran))
            {
                cmdN.Parameters.AddWithValue("@sid", sid);
                cmdN.Parameters.AddWithValue("@fid", currentFid);
                using (SqlDataReader dr = cmdN.ExecuteReader())
                {
                    if (dr.Read())
                    {
                        nextStatus = Convert.ToInt32(dr["status"]);
                        nextText = dr["statusText"].ToString();
                    }
                }
            }

            if (nextStatus == 0)
            {
                nextStatus = 21;
                nextText = "Scrap Note Closed at Warehouse";
            }

            // update main
            using (SqlCommand cmdU = new SqlCommand("UPDATE [tblScrapNote] SET [status]=@status,[statusText]=@statusText WHERE [sid]=@sid", con, tran))
            {
                cmdU.Parameters.AddWithValue("@status", nextStatus);
                cmdU.Parameters.AddWithValue("@statusText", nextText);
                cmdU.Parameters.AddWithValue("@sid", sid);
                cmdU.ExecuteNonQuery();
            }

            // insert flow with controllingComment
            string sqlInsert = "INSERT INTO [tblFlow] ([sid],[addedBy],[status],[statusText]," + commentColumn + ") VALUES (@sid,@addedBy,@status,@statusText,@comment)";
            using (SqlCommand cmdI = new SqlCommand(sqlInsert, con, tran))
            {
                cmdI.Parameters.AddWithValue("@sid", sid);
                cmdI.Parameters.AddWithValue("@addedBy", userId);
                cmdI.Parameters.AddWithValue("@status", nextStatus);
                cmdI.Parameters.AddWithValue("@statusText", nextText);
                cmdI.Parameters.AddWithValue("@comment", commentText);
                cmdI.ExecuteNonQuery();
            }

            tran.Commit();
            lblMessage.ForeColor = System.Drawing.Color.Green;
            lblMessage.Text = "Accepted and forwarded: " + nextText;
        }
    }
    catch (Exception ex)
    {
        try { if (tran != null && tran.Connection != null) tran.Rollback(); } catch { }
        lblMessage.ForeColor = System.Drawing.Color.Red;
        lblMessage.Text = "Exception occurred: " + ex.Message;
    }
}







protected void btnSubmit_Click(object sender, EventArgs e)
{
    SqlTransaction tran = null;
    try
    {
        int sid = Convert.ToInt32(hdnsid.Value);
        string userId = Session["uid"].ToString();
        string commentText = txtTaxRemark.Text.Trim(); // change if different
        string commentColumn = "taxationComment";
        int currentStatus = 2; // Taxation

        using (SqlConnection con = new SqlConnection(ConfigurationManager.ConnectionStrings["SiteSqlServer"].ToString()))
        {
            con.Open();
            tran = con.BeginTransaction();

            int currentFid = 0;
            using (SqlCommand cmdF = new SqlCommand("SELECT MIN([fid]) FROM [tblFlow] WHERE [sid]=@sid AND [status]=@status", con, tran))
            {
                cmdF.Parameters.AddWithValue("@sid", sid);
                cmdF.Parameters.AddWithValue("@status", currentStatus);
                object of = cmdF.ExecuteScalar();
                if (of != null && of != DBNull.Value) currentFid = Convert.ToInt32(of);
            }

            int nextStatus = 0; string nextText = "";
            using (SqlCommand cmdN = new SqlCommand("SELECT TOP 1 [fid],[status],[statusText] FROM [tblFlow] WHERE [sid]=@sid AND [fid] > @fid ORDER BY [fid] ASC", con, tran))
            {
                cmdN.Parameters.AddWithValue("@sid", sid);
                cmdN.Parameters.AddWithValue("@fid", currentFid);
                using (SqlDataReader dr = cmdN.ExecuteReader())
                {
                    if (dr.Read())
                    {
                        nextStatus = Convert.ToInt32(dr["status"]);
                        nextText = dr["statusText"].ToString();
                    }
                }
            }

            if (nextStatus == 0)
            {
                nextStatus = 21;
                nextText = "Scrap Note Closed at Warehouse";
            }

            using (SqlCommand cmdU = new SqlCommand("UPDATE [tblScrapNote] SET [status]=@status,[statusText]=@statusText WHERE [sid]=@sid", con, tran))
            {
                cmdU.Parameters.AddWithValue("@status", nextStatus);
                cmdU.Parameters.AddWithValue("@statusText", nextText);
                cmdU.Parameters.AddWithValue("@sid", sid);
                cmdU.ExecuteNonQuery();
            }

            string sqlInsert = "INSERT INTO [tblFlow] ([sid],[addedBy],[status],[statusText]," + commentColumn + ") VALUES (@sid,@addedBy,@status,@statusText,@comment)";
            using (SqlCommand cmdI = new SqlCommand(sqlInsert, con, tran))
            {
                cmdI.Parameters.AddWithValue("@sid", sid);
                cmdI.Parameters.AddWithValue("@addedBy", userId);
                cmdI.Parameters.AddWithValue("@status", nextStatus);
                cmdI.Parameters.AddWithValue("@statusText", nextText);
                cmdI.Parameters.AddWithValue("@comment", commentText);
                cmdI.ExecuteNonQuery();
            }

            tran.Commit();
            lblMessage.ForeColor = System.Drawing.Color.Green;
            lblMessage.Text = "Accepted and forwarded: " + nextText;
        }
    }
    catch (Exception ex)
    {
        try { if (tran != null && tran.Connection != null) tran.Rollback(); } catch { }
        lblMessage.ForeColor = System.Drawing.Color.Red;
        lblMessage.Text = "Exception occurred: " + ex.Message;
    }
}





protected void btnSubmit_Click(object sender, EventArgs e)
{
    SqlTransaction tran = null;
    try
    {
        int sid = Convert.ToInt32(hdnsid.Value);
        string userId = Session["uid"].ToString();
        string commentText = txtCOORemark.Text.Trim(); // your control name
        string commentColumn = "cooComment";
        int currentStatus = 3; // COO

        using (SqlConnection con = new SqlConnection(ConfigurationManager.ConnectionStrings["SiteSqlServer"].ToString()))
        {
            con.Open();
            tran = con.BeginTransaction();

            int currentFid = 0;
            using (SqlCommand cmdF = new SqlCommand("SELECT MIN([fid]) FROM [tblFlow] WHERE [sid]=@sid AND [status]=@status", con, tran))
            {
                cmdF.Parameters.AddWithValue("@sid", sid);
                cmdF.Parameters.AddWithValue("@status", currentStatus);
                object of = cmdF.ExecuteScalar();
                if (of != null && of != DBNull.Value) currentFid = Convert.ToInt32(of);
            }

            int nextStatus = 0; string nextText = "";
            using (SqlCommand cmdN = new SqlCommand("SELECT TOP 1 [fid],[status],[statusText] FROM [tblFlow] WHERE [sid]=@sid AND [fid] > @fid ORDER BY [fid] ASC", con, tran))
            {
                cmdN.Parameters.AddWithValue("@sid", sid);
                cmdN.Parameters.AddWithValue("@fid", currentFid);
                using (SqlDataReader dr = cmdN.ExecuteReader())
                {
                    if (dr.Read())
                    {
                        nextStatus = Convert.ToInt32(dr["status"]);
                        nextText = dr["statusText"].ToString();
                    }
                }
            }

            if (nextStatus == 0)
            {
                nextStatus = 21;
                nextText = "Scrap Note Closed at Warehouse";
            }

            using (SqlCommand cmdU = new SqlCommand("UPDATE [tblScrapNote] SET [status]=@status,[statusText]=@statusText WHERE [sid]=@sid", con, tran))
            {
                cmdU.Parameters.AddWithValue("@status", nextStatus);
                cmdU.Parameters.AddWithValue("@statusText", nextText);
                cmdU.Parameters.AddWithValue("@sid", sid);
                cmdU.ExecuteNonQuery();
            }

            string sqlInsert = "INSERT INTO [tblFlow] ([sid],[addedBy],[status],[statusText]," + commentColumn + ") VALUES (@sid,@addedBy,@status,@statusText,@comment)";
            using (SqlCommand cmdI = new SqlCommand(sqlInsert, con, tran))
            {
                cmdI.Parameters.AddWithValue("@sid", sid);
                cmdI.Parameters.AddWithValue("@addedBy", userId);
                cmdI.Parameters.AddWithValue("@status", nextStatus);
                cmdI.Parameters.AddWithValue("@statusText", nextText);
                cmdI.Parameters.AddWithValue("@comment", commentText);
                cmdI.ExecuteNonQuery();
            }

            tran.Commit();
            lblMessage.ForeColor = System.Drawing.Color.Green;
            lblMessage.Text = "Accepted and forwarded: " + nextText;
        }
    }
    catch (Exception ex)
    {
        try { if (tran != null && tran.Connection != null) tran.Rollback(); } catch { }
        lblMessage.ForeColor = System.Drawing.Color.Red;
        lblMessage.Text = "Exception occurred: " + ex.Message;
    }
}







protected void btnSubmit_Click(object sender, EventArgs e)
{
    SqlTransaction tran = null;
    try
    {
        int sid = Convert.ToInt32(hdnsid.Value);
        string userId = Session["uid"].ToString();
        string commentText = txtCfoRemark.Text.Trim(); // change if different
        string commentColumn = "cfoComment";
        int currentStatus = 4; // CFO

        using (SqlConnection con = new SqlConnection(ConfigurationManager.ConnectionStrings["SiteSqlServer"].ToString()))
        {
            con.Open();
            tran = con.BeginTransaction();

            int currentFid = 0;
            using (SqlCommand cmdF = new SqlCommand("SELECT MIN([fid]) FROM [tblFlow] WHERE [sid]=@sid AND [status]=@status", con, tran))
            {
                cmdF.Parameters.AddWithValue("@sid", sid);
                cmdF.Parameters.AddWithValue("@status", currentStatus);
                object of = cmdF.ExecuteScalar();
                if (of != null && of != DBNull.Value) currentFid = Convert.ToInt32(of);
            }

            int nextStatus = 0; string nextText = "";
            using (SqlCommand cmdN = new SqlCommand("SELECT TOP 1 [fid],[status],[statusText] FROM [tblFlow] WHERE [sid]=@sid AND [fid] > @fid ORDER BY [fid] ASC", con, tran))
            {
                cmdN.Parameters.AddWithValue("@sid", sid);
                cmdN.Parameters.AddWithValue("@fid", currentFid);
                using (SqlDataReader dr = cmdN.ExecuteReader())
                {
                    if (dr.Read())
                    {
                        nextStatus = Convert.ToInt32(dr["status"]);
                        nextText = dr["statusText"].ToString();
                    }
                }
            }

            if (nextStatus == 0)
            {
                nextStatus = 21;
                nextText = "Scrap Note Closed at Warehouse";
            }

            using (SqlCommand cmdU = new SqlCommand("UPDATE [tblScrapNote] SET [status]=@status,[statusText]=@statusText WHERE [sid]=@sid", con, tran))
            {
                cmdU.Parameters.AddWithValue("@status", nextStatus);
                cmdU.Parameters.AddWithValue("@statusText", nextText);
                cmdU.Parameters.AddWithValue("@sid", sid);
                cmdU.ExecuteNonQuery();
            }

            string sqlInsert = "INSERT INTO [tblFlow] ([sid],[addedBy],[status],[statusText]," + commentColumn + ") VALUES (@sid,@addedBy,@status,@statusText,@comment)";
            using (SqlCommand cmdI = new SqlCommand(sqlInsert, con, tran))
            {
                cmdI.Parameters.AddWithValue("@sid", sid);
                cmdI.Parameters.AddWithValue("@addedBy", userId);
                cmdI.Parameters.AddWithValue("@status", nextStatus);
                cmdI.Parameters.AddWithValue("@statusText", nextText);
                cmdI.Parameters.AddWithValue("@comment", commentText);
                cmdI.ExecuteNonQuery();
            }

            tran.Commit();
            lblMessage.ForeColor = System.Drawing.Color.Green;
            lblMessage.Text = "Accepted and forwarded: " + nextText;
        }
    }
    catch (Exception ex)
    {
        try { if (tran != null && tran.Connection != null) tran.Rollback(); } catch { }
        lblMessage.ForeColor = System.Drawing.Color.Red;
        lblMessage.Text = "Exception occurred: " + ex.Message;
    }
}






protected void btnSubmit_Click(object sender, EventArgs e)
{
    SqlTransaction tran = null;
    try
    {
        int sid = Convert.ToInt32(hdnsid.Value);
        string userId = Session["uid"].ToString();
        string commentText = txtWHRemark.Text.Trim(); // change if different
        string commentColumn = "whComment";
        int currentStatus = 5; // Warehouse mid-step

        using (SqlConnection con = new SqlConnection(ConfigurationManager.ConnectionStrings["SiteSqlServer"].ToString()))
        {
            con.Open();
            tran = con.BeginTransaction();

            int currentFid = 0;
            using (SqlCommand cmdF = new SqlCommand("SELECT MIN([fid]) FROM [tblFlow] WHERE [sid]=@sid AND [status]=@status", con, tran))
            {
                cmdF.Parameters.AddWithValue("@sid", sid);
                cmdF.Parameters.AddWithValue("@status", currentStatus);
                object of = cmdF.ExecuteScalar();
                if (of != null && of != DBNull.Value) currentFid = Convert.ToInt32(of);
            }

            int nextStatus = 0; string nextText = "";
            using (SqlCommand cmdN = new SqlCommand("SELECT TOP 1 [fid],[status],[statusText] FROM [tblFlow] WHERE [sid]=@sid AND [fid] > @fid ORDER BY [fid] ASC", con, tran))
            {
                cmdN.Parameters.AddWithValue("@sid", sid);
                cmdN.Parameters.AddWithValue("@fid", currentFid);
                using (SqlDataReader dr = cmdN.ExecuteReader())
                {
                    if (dr.Read())
                    {
                        nextStatus = Convert.ToInt32(dr["status"]);
                        nextText = dr["statusText"].ToString();
                    }
                }
            }

            if (nextStatus == 0)
            {
                nextStatus = 21;
                nextText = "Scrap Note Closed at Warehouse";
            }

            using (SqlCommand cmdU = new SqlCommand("UPDATE [tblScrapNote] SET [status]=@status,[statusText]=@statusText WHERE [sid]=@sid", con, tran))
            {
                cmdU.Parameters.AddWithValue("@status", nextStatus);
                cmdU.Parameters.AddWithValue("@statusText", nextText);
                cmdU.Parameters.AddWithValue("@sid", sid);
                cmdU.ExecuteNonQuery();
            }

            string sqlInsert = "INSERT INTO [tblFlow] ([sid],[addedBy],[status],[statusText]," + commentColumn + ") VALUES (@sid,@addedBy,@status,@statusText,@comment)";
            using (SqlCommand cmdI = new SqlCommand(sqlInsert, con, tran))
            {
                cmdI.Parameters.AddWithValue("@sid", sid);
                cmdI.Parameters.AddWithValue("@addedBy", userId);
                cmdI.Parameters.AddWithValue("@status", nextStatus);
                cmdI.Parameters.AddWithValue("@statusText", nextText);
                cmdI.Parameters.AddWithValue("@comment", commentText);
                cmdI.ExecuteNonQuery();
            }

            tran.Commit();
            lblMessage.ForeColor = System.Drawing.Color.Green;
            lblMessage.Text = "Accepted and forwarded: " + nextText;
        }
    }
    catch (Exception ex)
    {
        try { if (tran != null && tran.Connection != null) tran.Rollback(); } catch { }
        lblMessage.ForeColor = System.Drawing.Color.Red;
        lblMessage.Text = "Exception occurred: " + ex.Message;
    }
}







protected void btnSubmit_Click(object sender, EventArgs e)
{
    SqlTransaction tran = null;
    try
    {
        int sid = Convert.ToInt32(hdnsid.Value);
        string userId = Session["uid"].ToString();
        string commentText = txtBABURemark.Text.Trim(); // change control if different
        string commentColumn = "babuComment";
        int currentStatus = 6; // BA/BU

        using (SqlConnection con = new SqlConnection(ConfigurationManager.ConnectionStrings["SiteSqlServer"].ToString()))
        {
            con.Open();
            tran = con.BeginTransaction();

            int currentFid = 0;
            using (SqlCommand cmdF = new SqlCommand("SELECT MIN([fid]) FROM [tblFlow] WHERE [sid]=@sid AND [status]=@status", con, tran))
            {
                cmdF.Parameters.AddWithValue("@sid", sid);
                cmdF.Parameters.AddWithValue("@status", currentStatus);
                object of = cmdF.ExecuteScalar();
                if (of != null && of != DBNull.Value) currentFid = Convert.ToInt32(of);
            }

            int nextStatus = 0; string nextText = "";
            using (SqlCommand cmdN = new SqlCommand("SELECT TOP 1 [fid],[status],[statusText] FROM [tblFlow] WHERE [sid]=@sid AND [fid] > @fid ORDER BY [fid] ASC", con, tran))
            {
                cmdN.Parameters.AddWithValue("@sid", sid);
                cmdN.Parameters.AddWithValue("@fid", currentFid);
                using (SqlDataReader dr = cmdN.ExecuteReader())
                {
                    if (dr.Read())
                    {
                        nextStatus = Convert.ToInt32(dr["status"]);
                        nextText = dr["statusText"].ToString();
                    }
                }
            }

            if (nextStatus == 0)
            {
                nextStatus = 21;
                nextText = "Scrap Note Closed at Warehouse";
            }

            using (SqlCommand cmdU = new SqlCommand("UPDATE [tblScrapNote] SET [status]=@status,[statusText]=@statusText WHERE [sid]=@sid", con, tran))
            {
                cmdU.Parameters.AddWithValue("@status", nextStatus);
                cmdU.Parameters.AddWithValue("@statusText", nextText);
                cmdU.Parameters.AddWithValue("@sid", sid);
                cmdU.ExecuteNonQuery();
            }

            string sqlInsert = "INSERT INTO [tblFlow] ([sid],[addedBy],[status],[statusText]," + commentColumn + ") VALUES (@sid,@addedBy,@status,@statusText,@comment)";
            using (SqlCommand cmdI = new SqlCommand(sqlInsert, con, tran))
            {
                cmdI.Parameters.AddWithValue("@sid", sid);
                cmdI.Parameters.AddWithValue("@addedBy", userId);
                cmdI.Parameters.AddWithValue("@status", nextStatus);
                cmdI.Parameters.AddWithValue("@statusText", nextText);
                cmdI.Parameters.AddWithValue("@comment", commentText);
                cmdI.ExecuteNonQuery();
            }

            tran.Commit();
            lblMessage.ForeColor = System.Drawing.Color.Green;
            lblMessage.Text = "Accepted and forwarded: " + nextText;
        }
    }
    catch (Exception ex)
    {
        try { if (tran != null && tran.Connection != null) tran.Rollback(); } catch { }
        lblMessage.ForeColor = System.Drawing.Color.Red;
        lblMessage.Text = "Exception occurred: " + ex.Message;
    }
}








protected void btnSubmit_Click(object sender, EventArgs e)
{
    SqlTransaction tran = null;
    try
    {
        int sid = Convert.ToInt32(hdnsid.Value);
        string userId = Session["uid"].ToString();
        string commentText = txtBgCfoRemark.Text.Trim(); // change if different
        string commentColumn = "bgCfoComment";
        int currentStatus = 7; // BG/CFO

        using (SqlConnection con = new SqlConnection(ConfigurationManager.ConnectionStrings["SiteSqlServer"].ToString()))
        {
            con.Open();
            tran = con.BeginTransaction();

            int currentFid = 0;
            using (SqlCommand cmdF = new SqlCommand("SELECT MIN([fid]) FROM [tblFlow] WHERE [sid]=@sid AND [status]=@status", con, tran))
            {
                cmdF.Parameters.AddWithValue("@sid", sid);
                cmdF.Parameters.AddWithValue("@status", currentStatus);
                object of = cmdF.ExecuteScalar();
                if (of != null && of != DBNull.Value) currentFid = Convert.ToInt32(of);
            }

            int nextStatus = 0; string nextText = "";
            using (SqlCommand cmdN = new SqlCommand("SELECT TOP 1 [fid],[status],[statusText] FROM [tblFlow] WHERE [sid]=@sid AND [fid] > @fid ORDER BY [fid] ASC", con, tran))
            {
                cmdN.Parameters.AddWithValue("@sid", sid);
                cmdN.Parameters.AddWithValue("@fid", currentFid);
                using (SqlDataReader dr = cmdN.ExecuteReader())
                {
                    if (dr.Read())
                    {
                        nextStatus = Convert.ToInt32(dr["status"]);
                        nextText = dr["statusText"].ToString();
                    }
                }
            }

            if (nextStatus == 0)
            {
                nextStatus = 21;
                nextText = "Scrap Note Closed at Warehouse";
            }

            using (SqlCommand cmdU = new SqlCommand("UPDATE [tblScrapNote] SET [status]=@status,[statusText]=@statusText WHERE [sid]=@sid", con, tran))
            {
                cmdU.Parameters.AddWithValue("@status", nextStatus);
                cmdU.Parameters.AddWithValue("@statusText", nextText);
                cmdU.Parameters.AddWithValue("@sid", sid);
                cmdU.ExecuteNonQuery();
            }

            string sqlInsert = "INSERT INTO [tblFlow] ([sid],[addedBy],[status],[statusText]," + commentColumn + ") VALUES (@sid,@addedBy,@status,@statusText,@comment)";
            using (SqlCommand cmdI = new SqlCommand(sqlInsert, con, tran))
            {
                cmdI.Parameters.AddWithValue("@sid", sid);
                cmdI.Parameters.AddWithValue("@addedBy", userId);
                cmdI.Parameters.AddWithValue("@status", nextStatus);
                cmdI.Parameters.AddWithValue("@statusText", nextText);
                cmdI.Parameters.AddWithValue("@comment", commentText);
                cmdI.ExecuteNonQuery();
            }

            tran.Commit();
            lblMessage.ForeColor = System.Drawing.Color.Green;
            lblMessage.Text = "Accepted and forwarded: " + nextText;
        }
    }
    catch (Exception ex)
    {
        try { if (tran != null && tran.Connection != null) tran.Rollback(); } catch { }
        lblMessage.ForeColor = System.Drawing.Color.Red;
        lblMessage.Text = "Exception occurred: " + ex.Message;
    }
}







protected void btnSubmit_Click(object sender, EventArgs e)
{
    SqlTransaction tran = null;
    try
    {
        int sid = Convert.ToInt32(hdnsid.Value);
        string userId = Session["uid"].ToString();
        string commentText = txtBgCeoRemark.Text.Trim(); // change if differs
        string commentColumn = "bgCeoComment";
        int currentStatus = 8; // BG/CEO

        using (SqlConnection con = new SqlConnection(ConfigurationManager.ConnectionStrings["SiteSqlServer"].ToString()))
        {
            con.Open();
            tran = con.BeginTransaction();

            int currentFid = 0;
            using (SqlCommand cmdF = new SqlCommand("SELECT MIN([fid]) FROM [tblFlow] WHERE [sid]=@sid AND [status]=@status", con, tran))
            {
                cmdF.Parameters.AddWithValue("@sid", sid);
                cmdF.Parameters.AddWithWithValue("@status", currentStatus); // typo-safe: if your project uses different fetch, ensure consistency
                object of = cmdF.ExecuteScalar();
                if (of != null && of != DBNull.Value) currentFid = Convert.ToInt32(of);
            }

            int nextStatus = 0; string nextText = "";
            using (SqlCommand cmdN = new SqlCommand("SELECT TOP 1 [fid],[status],[statusText] FROM [tblFlow] WHERE [sid]=@sid AND [fid] > @fid ORDER BY [fid] ASC", con, tran))
            {
                cmdN.Parameters.AddWithValue("@sid", sid);
                cmdN.Parameters.AddWithValue("@fid", currentFid);
                using (SqlDataReader dr = cmdN.ExecuteReader())
                {
                    if (dr.Read())
                    {
                        nextStatus = Convert.ToInt32(dr["status"]);
                        nextText = dr["statusText"].ToString();
                    }
                }
            }

            if (nextStatus == 0)
            {
                nextStatus = 21;
                nextText = "Scrap Note Closed at Warehouse";
            }

            using (SqlCommand cmdU = new SqlCommand("UPDATE [tblScrapNote] SET [status]=@status,[statusText]=@statusText WHERE [sid]=@sid", con, tran))
            {
                cmdU.Parameters.AddWithValue("@status", nextStatus);
                cmdU.Parameters.AddWithValue("@statusText", nextText);
                cmdU.Parameters.AddWithValue("@sid", sid);
                cmdU.ExecuteNonQuery();
            }

            string sqlInsert = "INSERT INTO [tblFlow] ([sid],[addedBy],[status],[statusText]," + commentColumn + ") VALUES (@sid,@addedBy,@status,@statusText,@comment)";
            using (SqlCommand cmdI = new SqlCommand(sqlInsert, con, tran))
            {
                cmdI.Parameters.AddWithValue("@sid", sid);
                cmdI.Parameters.AddWithValue("@addedBy", userId);
                cmdI.Parameters.AddWithValue("@status", nextStatus);
                cmdI.Parameters.AddWithValue("@statusText", nextText);
                cmdI.Parameters.AddWithValue("@comment", commentText);
                cmdI.ExecuteNonQuery();
            }

            tran.Commit();
            lblMessage.ForeColor = System.Drawing.Color.Green;
            lblMessage.Text = "Accepted and forwarded: " + nextText;
        }
    }
    catch (Exception ex)
    {
        try { if (tran != null && tran.Connection != null) tran.Rollback(); } catch { }
        lblMessage.ForeColor = System.Drawing.Color.Red;
        lblMessage.Text = "Exception occurred: " + ex.Message;
    }
}





protected void btnSubmit_Click(object sender, EventArgs e)
{
    SqlTransaction tran = null;
    try
    {
        int sid = Convert.ToInt32(hdnsid.Value);
        string userId = Session["uid"].ToString();
        string commentText = txtEnvRemark.Text.Trim(); // change if different
        string commentColumn = "envComment";
        int currentStatus = 9; // ENV

        using (SqlConnection con = new SqlConnection(ConfigurationManager.ConnectionStrings["SiteSqlServer"].ToString()))
        {
            con.Open();
            tran = con.BeginTransaction();

            int currentFid = 0;
            using (SqlCommand cmdF = new SqlCommand("SELECT MIN([fid]) FROM [tblFlow] WHERE [sid]=@sid AND [status]=@status", con, tran))
            {
                cmdF.Parameters.AddWithValue("@sid", sid);
                cmdF.Parameters.AddWithValue("@status", currentStatus);
                object of = cmdF.ExecuteScalar();
                if (of != null && of != DBNull.Value) currentFid = Convert.ToInt32(of);
            }

            int nextStatus = 0; string nextText = "";
            using (SqlCommand cmdN = new SqlCommand("SELECT TOP 1 [fid],[status],[statusText] FROM [tblFlow] WHERE [sid]=@sid AND [fid] > @fid ORDER BY [fid] ASC", con, tran))
            {
                cmdN.Parameters.AddWithValue("@sid", sid);
                cmdN.Parameters.AddWithValue("@fid", currentFid);
                using (SqlDataReader dr = cmdN.ExecuteReader())
                {
                    if (dr.Read())
                    {
                        nextStatus = Convert.ToInt32(dr["status"]);
                        nextText = dr["statusText"].ToString();
                    }
                }
            }

            if (nextStatus == 0)
            {
                nextStatus = 21;
                nextText = "Scrap Note Closed at Warehouse";
            }

            using (SqlCommand cmdU = new SqlCommand("UPDATE [tblScrapNote] SET [status]=@status,[statusText]=@statusText WHERE [sid]=@sid", con, tran))
            {
                cmdU.Parameters.AddWithValue("@status", nextStatus);
                cmdU.Parameters.AddWithValue("@statusText", nextText);
                cmdU.Parameters.AddWithValue("@sid", sid);
                cmdU.ExecuteNonQuery();
            }

            string sqlInsert = "INSERT INTO [tblFlow] ([sid],[addedBy],[status],[statusText]," + commentColumn + ") VALUES (@sid,@addedBy,@status,@statusText,@comment)";
            using (SqlCommand cmdI = new SqlCommand(sqlInsert, con, tran))
            {
                cmdI.Parameters.AddWithValue("@sid", sid);
                cmdI.Parameters.AddWithValue("@addedBy", userId);
                cmdI.Parameters.AddWithValue("@status", nextStatus);
                cmdI.Parameters.AddWithValue("@statusText", nextText);
                cmdI.Parameters.AddWithValue("@comment", commentText);
                cmdI.ExecuteNonQuery();
            }

            tran.Commit();
            lblMessage.ForeColor = System.Drawing.Color.Green;
            lblMessage.Text = "Accepted and forwarded: " + nextText;
        }
    }
    catch (Exception ex)
    {
        try { if (tran != null && tran.Connection != null) tran.Rollback(); } catch { }
        lblMessage.ForeColor = System.Drawing.Color.Red;
        lblMessage.Text = "Exception occurred: " + ex.Message;
    }
}






protected void btnClose_Click(object sender, EventArgs e)
{
    try
    {
        int sid = Convert.ToInt32(hdnsid.Value);
        string userId = Session["uid"].ToString();
        string commentText = txtWHRemark.Text.Trim(); // change control if different

        using (SqlConnection con = new SqlConnection(ConfigurationManager.ConnectionStrings["SiteSqlServer"].ToString()))
        {
            con.Open();

            using (SqlCommand cmdU = new SqlCommand("UPDATE [tblScrapNote] SET [status]=21,[statusText]='Closed at Warehouse' WHERE [sid]=@sid", con))
            {
                cmdU.Parameters.AddWithValue("@sid", sid);
                cmdU.ExecuteNonQuery();
            }

            using (SqlCommand cmdI = new SqlCommand("INSERT INTO [tblFlow] ([sid],[addedBy],[status],[statusText],[whComment]) VALUES (@sid,@addedBy,21,'Closed at Warehouse',@comment)", con))
            {
                cmdI.Parameters.AddWithValue("@sid", sid);
                cmdI.Parameters.AddWithValue("@addedBy", userId);
                cmdI.Parameters.AddWithValue("@comment", commentText);
                cmdI.ExecuteNonQuery();
            }

            lblMessage.ForeColor = System.Drawing.Color.Green;
            lblMessage.Text = "Scrap Note closed successfully.";
        }
    }
    catch (Exception ex)
    {
        lblMessage.ForeColor = System.Drawing.Color.Red;
        lblMessage.Text = "Error closing scrap note: " + ex.Message;
    }
}



private void ApplyBusinessRules(int sid, SqlConnection conn)
{
    try
    {
        decimal totalValue = 0;

        // Calculate total ScrapQtyStockValue
        using (SqlCommand cmd = new SqlCommand("SELECT ISNULL(SUM(CAST([ScrapQtyStockValue] AS DECIMAL(18,2))),0) FROM [tblScrapNoteTrans] WHERE [sid]=@sid", conn))
        {
            cmd.Parameters.AddWithValue("@sid", sid);
            totalValue = Convert.ToDecimal(cmd.ExecuteScalar());
        }

        // Clear old route if any
        using (SqlCommand cmdDel = new SqlCommand("DELETE FROM [tblFlow] WHERE [sid]=@sid", conn))
        {
            cmdDel.Parameters.AddWithValue("@sid", sid);
            cmdDel.ExecuteNonQuery();
        }

        // Build department route list
        List<(int status, string text)> route = new List<(int, string)>();

        if (totalValue <= 1000)
        {
            // BA/BU → ENV → Warehouse
            route.Add((6, "Pending at BA/BU"));
            route.Add((9, "Pending at Env"));
            route.Add((20, "Pending at Warehouse"));
        }
        else if (totalValue > 1000 && totalValue <= 5000)
        {
            // Warehouse → BA/BU → ENV → Warehouse
            route.Add((5, "Pending at Warehouse"));
            route.Add((6, "Pending at BA/BU"));
            route.Add((9, "Pending at Env"));
            route.Add((20, "Pending at Warehouse"));
        }
        else if (totalValue > 5000 && totalValue <= 20000)
        {
            // Controlling → Tax → COO → CFO → Warehouse → BA/BU → Warehouse
            route.Add((1, "Pending at Controlling"));
            route.Add((2, "Pending at Taxation"));
            route.Add((3, "Pending at COO"));
            route.Add((4, "Pending at CFO"));
            route.Add((5, "Pending at Warehouse"));
            route.Add((6, "Pending at BA/BU"));
            route.Add((20, "Pending at Warehouse"));
        }
        else if (totalValue > 20000 && totalValue <= 50000)
        {
            // Controlling → Tax → COO → CFO → Warehouse → BA/BU → BG/CFO → Warehouse
            route.Add((1, "Pending at Controlling"));
            route.Add((2, "Pending at Taxation"));
            route.Add((3, "Pending at COO"));
            route.Add((4, "Pending at CFO"));
            route.Add((5, "Pending at Warehouse"));
            route.Add((6, "Pending at BA/BU"));
            route.Add((7, "Pending at BG/CFO"));
            route.Add((20, "Pending at Warehouse"));
        }
        else // > 50000
        {
            // Controlling → Tax → COO → CFO → Warehouse → BA/BU → BG/CFO → BG/CEO → ENV → Warehouse
            route.Add((1, "Pending at Controlling"));
            route.Add((2, "Pending at Taxation"));
            route.Add((3, "Pending at COO"));
            route.Add((4, "Pending at CFO"));
            route.Add((5, "Pending at Warehouse"));
            route.Add((6, "Pending at BA/BU"));
            route.Add((7, "Pending at BG/CFO"));
            route.Add((8, "Pending at BG/CEO"));
            route.Add((9, "Pending at Env"));
            route.Add((20, "Pending at Warehouse"));
        }

        // Insert route in tblFlow
        int fid = 1;
        foreach (var step in route)
        {
            string sqlInsert = "INSERT INTO [tblFlow] ([sid],[addedBy],[status],[statusText]) VALUES (@sid,@addedBy,@status,@statusText)";
            using (SqlCommand cmdIns = new SqlCommand(sqlInsert, conn))
            {
                cmdIns.Parameters.AddWithValue("@sid", sid);
                cmdIns.Parameters.AddWithValue("@addedBy", Session["uid"].ToString());
                cmdIns.Parameters.AddWithValue("@status", step.status);
                cmdIns.Parameters.AddWithValue("@statusText", step.text);
                cmdIns.ExecuteNonQuery();
            }
            fid++;
        }

        // Update tblScrapNote with the first step of the route
        var firstStep = route.First();
        using (SqlCommand cmdUp = new SqlCommand("UPDATE [tblScrapNote] SET [status]=@status, [statusText]=@statusText WHERE [sid]=@sid", conn))
        {
            cmdUp.Parameters.AddWithValue("@sid", sid);
            cmdUp.Parameters.AddWithValue("@status", firstStep.status);
            cmdUp.Parameters.AddWithValue("@statusText", firstStep.text);
            cmdUp.ExecuteNonQuery();
        }

        lblMessage.ForeColor = System.Drawing.Color.Green;
        lblMessage.Text = "Business rule applied. Total value = " + totalValue.ToString("N2") + " INR.";
    }
    catch (Exception ex)
    {
        lblMessage.ForeColor = System.Drawing.Color.Red;
        lblMessage.Text = "Error applying business rules: " + ex.Message;
    }
}







private class FlowStep
{
    public int Status;
    public string StatusText;
}

private void ApplyBusinessRules(int sid, SqlConnection conn)
{
    try
    {
        decimal totalValue = 0;

        // Calculate total ScrapQtyStockValue
        using (SqlCommand cmd = new SqlCommand("SELECT ISNULL(SUM(CAST([ScrapQtyStockValue] AS DECIMAL(18,2))),0) FROM [tblScrapNoteTrans] WHERE [sid]=@sid", conn))
        {
            cmd.Parameters.AddWithValue("@sid", sid);
            object result = cmd.ExecuteScalar();
            if (result != DBNull.Value && result != null)
                totalValue = Convert.ToDecimal(result);
        }

        // Clear any existing flow for this scrap note
        using (SqlCommand cmdDel = new SqlCommand("DELETE FROM [tblFlow] WHERE [sid]=@sid", conn))
        {
            cmdDel.Parameters.AddWithValue("@sid", sid);
            cmdDel.ExecuteNonQuery();
        }

        // Prepare route list
        List<FlowStep> route = new List<FlowStep>();

        if (totalValue <= 1000)
        {
            // BA/BU → Env → Warehouse
            route.Add(new FlowStep { Status = 6, StatusText = "Pending at BA/BU" });
            route.Add(new FlowStep { Status = 9, StatusText = "Pending at Env" });
            route.Add(new FlowStep { Status = 20, StatusText = "Pending at Warehouse" });
        }
        else if (totalValue > 1000 && totalValue <= 5000)
        {
            // Warehouse → BA/BU → Env → Warehouse
            route.Add(new FlowStep { Status = 5, StatusText = "Pending at Warehouse" });
            route.Add(new FlowStep { Status = 6, StatusText = "Pending at BA/BU" });
            route.Add(new FlowStep { Status = 9, StatusText = "Pending at Env" });
            route.Add(new FlowStep { Status = 20, StatusText = "Pending at Warehouse" });
        }
        else if (totalValue > 5000 && totalValue <= 20000)
        {
            // Controlling → Tax → COO → CFO → Warehouse → BA/BU → Warehouse
            route.Add(new FlowStep { Status = 1, StatusText = "Pending at Controlling" });
            route.Add(new FlowStep { Status = 2, StatusText = "Pending at Taxation" });
            route.Add(new FlowStep { Status = 3, StatusText = "Pending at COO" });
            route.Add(new FlowStep { Status = 4, StatusText = "Pending at CFO" });
            route.Add(new FlowStep { Status = 5, StatusText = "Pending at Warehouse" });
            route.Add(new FlowStep { Status = 6, StatusText = "Pending at BA/BU" });
            route.Add(new FlowStep { Status = 20, StatusText = "Pending at Warehouse" });
        }
        else if (totalValue > 20000 && totalValue <= 50000)
        {
            // Controlling → Tax → COO → CFO → Warehouse → BA/BU → BG/CFO → Warehouse
            route.Add(new FlowStep { Status = 1, StatusText = "Pending at Controlling" });
            route.Add(new FlowStep { Status = 2, StatusText = "Pending at Taxation" });
            route.Add(new FlowStep { Status = 3, StatusText = "Pending at COO" });
            route.Add(new FlowStep { Status = 4, StatusText = "Pending at CFO" });
            route.Add(new FlowStep { Status = 5, StatusText = "Pending at Warehouse" });
            route.Add(new FlowStep { Status = 6, StatusText = "Pending at BA/BU" });
            route.Add(new FlowStep { Status = 7, StatusText = "Pending at BG/CFO" });
            route.Add(new FlowStep { Status = 20, StatusText = "Pending at Warehouse" });
        }
        else
        {
            // >50000 → Controlling → Tax → COO → CFO → Warehouse → BA/BU → BG/CFO → BG/CEO → Env → Warehouse
            route.Add(new FlowStep { Status = 1, StatusText = "Pending at Controlling" });
            route.Add(new FlowStep { Status = 2, StatusText = "Pending at Taxation" });
            route.Add(new FlowStep { Status = 3, StatusText = "Pending at COO" });
            route.Add(new FlowStep { Status = 4, StatusText = "Pending at CFO" });
            route.Add(new FlowStep { Status = 5, StatusText = "Pending at Warehouse" });
            route.Add(new FlowStep { Status = 6, StatusText = "Pending at BA/BU" });
            route.Add(new FlowStep { Status = 7, StatusText = "Pending at BG/CFO" });
            route.Add(new FlowStep { Status = 8, StatusText = "Pending at BG/CEO" });
            route.Add(new FlowStep { Status = 9, StatusText = "Pending at Env" });
            route.Add(new FlowStep { Status = 20, StatusText = "Pending at Warehouse" });
        }

        // Insert all route steps into tblFlow
        foreach (FlowStep step in route)
        {
            string sqlInsert = "INSERT INTO [tblFlow] ([sid],[addedBy],[status],[statusText]) VALUES (@sid,@addedBy,@status,@statusText)";
            using (SqlCommand cmdIns = new SqlCommand(sqlInsert, conn))
            {
                cmdIns.Parameters.AddWithValue("@sid", sid);
                cmdIns.Parameters.AddWithValue("@addedBy", Session["uid"].ToString());
                cmdIns.Parameters.AddWithValue("@status", step.Status);
                cmdIns.Parameters.AddWithValue("@statusText", step.StatusText);
                cmdIns.ExecuteNonQuery();
            }
        }

        // Update tblScrapNote with the first step
        if (route.Count > 0)
        {
            FlowStep first = route[0];
            using (SqlCommand cmdUp = new SqlCommand("UPDATE [tblScrapNote] SET [status]=@status,[statusText]=@statusText WHERE [sid]=@sid", conn))
            {
                cmdUp.Parameters.AddWithValue("@sid", sid);
                cmdUp.Parameters.AddWithValue("@status", first.Status);
                cmdUp.Parameters.AddWithValue("@statusText", first.StatusText);
                cmdUp.ExecuteNonQuery();
            }
        }

        lblMessage.ForeColor = System.Drawing.Color.Green;
        lblMessage.Text = "Business rules applied successfully (Total Value: " + totalValue.ToString("N2") + ")";
    }
    catch (Exception ex)
    {
        lblMessage.ForeColor = System.Drawing.Color.Red;
        lblMessage.Text = "Error applying business rules: " + ex.Message;
    }
}